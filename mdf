# Initialize output variable
$Output = ""

# Get currently logged-in interactive user
$User = (Get-WmiObject -Class Win32_ComputerSystem).UserName
if (-not $User) { 
    $Output += "No logged-in user found`n"
    exit 
}

# Extract just the username (without domain)
$Username = $User.Split('\')[1]

# Get the SID for that username
$SID = (Get-WmiObject Win32_UserAccount -Filter "Name='$Username'").SID

$Output += "Logged-in user: $Username`n"
$Output += "SID: $SID`n"

# Get mapped drives from HKU\<SID>\Network
$NetworkKey = "Registry::HKEY_USERS\$SID\Network"
if (Test-Path $NetworkKey) {
    $Output += "=== Mapped Network Drives ===`n"
    Get-ChildItem $NetworkKey | ForEach-Object {
        $DriveLetter = $_.PSChildName
        $RemotePath = (Get-ItemProperty $_.PSPath).RemotePath
        $Output += "$DriveLetter -> $RemotePath`n"
    }
} else {
    $Output += "No mapped drives found for this user.`n"
}

# Build file name with hostname and timestamp
$Hostname = $env:COMPUTERNAME
$TimeStamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
$OutputFile = "C:\Temp\MappedDrives_$Hostname_$TimeStamp.txt"

# Write output to file
$Output | Out-File -FilePath $OutputFile -Encoding UTF8

Write-Host "Mapped drives saved to $OutputFile"
