# ===== SETTINGS =====
$InputFile  = "C:\Temp\YourInputFile.csv"   # Path to your exported Excel/CSV
$OutputFolder = "$env:USERPROFILE\Documents" # Output folder (safe for permissions)
$OutputFile = Join-Path $OutputFolder "AutopilotReady.csv"
$DefaultGroupTag = "FinanceDept"            # Group Tag to apply to all devices

# Create output folder if it doesn't exist
if (-not (Test-Path $OutputFolder)) {
    New-Item -ItemType Directory -Path $OutputFolder | Out-Null
}

# ===== MAPPING SECTION =====
$SerialCol    = "Serial No"
$ProductIDCol = "Win Product Id"
$HashCol      = "Hash"
$GroupTagCol  = ""   # Leave blank if not present

# ===== SCRIPT =====
Write-Host "Reading $InputFile ..." -ForegroundColor Cyan

$data = Import-Csv $InputFile

$csvOutput = $data | Select-Object `
    @{Name='Device Serial Number'; Expression = { $_.$SerialCol }},
    @{Name='Windows Product ID';    Expression = { if ($ProductIDCol -and $_.$ProductIDCol) { $_.$ProductIDCol } else { "" } }},
    @{Name='Hardware Hash';         Expression = { $_.$HashCol }},
    @{Name='Group Tag';             Expression = { 
        if ($GroupTagCol -and $_.$GroupTagCol) { $_.$GroupTagCol }
        else { $DefaultGroupTag }
    }}

# Export manually line by line to avoid quotes and handle access issues
$header = "Device Serial Number,Windows Product ID,Hardware Hash,Group Tag"
$header | Out-File -FilePath $OutputFile -Encoding UTF8 -Force
$csvOutput | ForEach-Object {
    "$($_.'Device Serial Number'),$($_.'Windows Product ID'),$($_.'Hardware Hash'),$($_.'Group Tag')"
} | Out-File -FilePath $OutputFile -Encoding UTF8 -Append -Force

Write-Host "âœ… Done! Autopilot-ready CSV saved to $OutputFile" -ForegroundColor Green
Write-Host "   Group Tag applied: $DefaultGroupTag" -ForegroundColor Yellow
